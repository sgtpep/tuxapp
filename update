#!/bin/bash
set -eu -o pipefail

diff_path=~/tuxapp.diff
project_path=${0%/*}
root_path=/var/www/html

function on-exit {
  local status=$?
  [[ $status == 0 ]] || echo "Exit status: $status" >&2
  exit $status
}
trap on-exit EXIT

git -C "$project_path" pull -q
"$project_path"/validate "$@" || :
"$project_path"/test "$@"
"$project_path"/parse "$@"
"$project_path"/generate "$@"
"$project_path"/diff {"$root_path","$project_path"/build}/apps > "$diff_path" || :
head -1000 "$diff_path"
rsync -Oac --delete "$project_path"/build/ "$root_path"
